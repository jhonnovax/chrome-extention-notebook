# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Loading the Extension

There is no build step. To test changes:
1. Go to `chrome://extensions` in Chrome
2. Enable "Developer mode" (top right)
3. Click "Load unpacked" → select this folder
4. After editing files, click the refresh icon on the extension card

The popup opens at **500×560px** (width set in `popup.css` on `html, body` and `.app`).

## Architecture

Four files, no dependencies, no bundler:

- **`manifest.json`** — Manifest V3. Only permission is `storage`. No background worker, no content scripts.
- **`popup.html`** — Static shell. Three regions: tab bar (`#tab-bar`), toolbar (`#toolbar`), editor (`#editor`). Tab items and toolbar buttons are DOM-generated by JS, not in the HTML.
- **`popup.css`** — All styling via CSS custom properties on `:root` (light), overridden by `@media (prefers-color-scheme: dark)`. No JS involvement in theming.
- **`popup.js`** — Single IIFE containing five named module objects: `STATE`, `STORAGE`, `TABS`, `EDITOR`, `TOOLBAR`, plus `init()`.

## popup.js Module Responsibilities

| Module | Role |
|--------|------|
| `STATE` | In-memory source of truth: `tabs[]`, `activeTabId`, `isDirty`, `saveTimer` |
| `STORAGE` | Wraps `chrome.storage.local`. Key: `notebookData`. Debounced save (600ms) + immediate `flush()` on `visibilitychange → hidden` |
| `EDITOR` | Wraps the `contenteditable` div. Handles `<br>` normalization, Tab-key interception, caret placement |
| `TOOLBAR` | Renders buttons from `COMMANDS` array; uses `document.execCommand` for formatting; polls `queryCommandState`/`queryCommandValue` on `selectionchange` to set `.is-active` |
| `TABS` | Renders tab strip via full `redraw()`. Handles create, delete, rename (inline `<input>`), and switch (with RAF fade) |

## Storage Schema

```json
{
  "notebookData": {
    "activeTabId": "tab-1700000000000",
    "tabs": [{ "id", "name", "content", "createdAt", "updatedAt" }]
  }
}
```

`content` is raw `innerHTML` from the contenteditable element.

## Key Behaviors to Preserve

- **Save on close**: `visibilitychange → hidden` triggers `STORAGE.flush()` synchronously — critical because the popup process is killed on close before async timers fire.
- **Toolbar focus**: toolbar buttons use `mousedown → preventDefault()` to prevent editor blur before `execCommand` runs.
- **Placeholder**: CSS `:empty::before` on `.editor`. `EDITOR` normalizes `innerHTML === '<br>'` → `''` on every `input` event to keep `:empty` working.
- **Tab rename**: `TABS.startRename()` injects a `.tab-rename-input` and adds `.tab-item--rename` to the parent, which CSS uses to hide the label and delete button during editing.
- **Single tab guard**: delete button gets `disabled` attribute when `STATE.tabs.length <= 1`; CSS `[disabled] { display: none }` hides it.

## CSS Conventions

- All colors and transitions are CSS custom properties — never hardcode color values in rules.
- Popup dimensions are set in three places that must stay in sync: `html, body` and `.app` in `popup.css`.
- Editor uses Georgia/serif; UI chrome uses system-ui/sans-serif.
- `.is-active` on toolbar buttons and `.is-switching` on the editor are the only JS-toggled CSS classes.
